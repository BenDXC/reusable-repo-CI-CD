# ============================================================================
# Reusable CI Workflow — .NET (C# / F#)
# ============================================================================
# Restores, builds, tests, and optionally publishes .NET projects.
#
# Usage (caller workflow):
#   jobs:
#     ci:
#       uses: <owner>/<repo>/.github/workflows/reusable-ci-dotnet.yml@main
#       with:
#         dotnet-versions: '["8.0.x", "9.0.x"]'
# ============================================================================

name: "CI — .NET"

on:
  workflow_call:
    inputs:
      dotnet-versions:
        description: "JSON array of .NET SDK versions"
        type: string
        default: '["8.0.x"]'
      working-directory:
        description: "Working directory for the project"
        type: string
        default: "."
      solution-file:
        description: "Path to solution or project file (relative to working-directory)"
        type: string
        default: ""
      enable-test:
        description: "Run tests"
        type: boolean
        default: true
      enable-coverage:
        description: "Upload coverage reports"
        type: boolean
        default: false
      build-configuration:
        description: "Build configuration: Debug | Release"
        type: string
        default: "Release"
      dotnet-test-args:
        description: "Additional dotnet test arguments"
        type: string
        default: ""
      enable-format-check:
        description: "Run dotnet format check"
        type: boolean
        default: false
    secrets:
      codecov-token:
        description: "Codecov upload token"
        required: false
      nuget-auth-token:
        description: "NuGet feed authentication token"
        required: false

permissions:
  contents: read

jobs:
  dotnet-ci:
    name: ".NET ${{ matrix.dotnet-version }}"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    strategy:
      fail-fast: false
      matrix:
        dotnet-version: ${{ fromJSON(inputs.dotnet-versions) }}

    steps:
      # ── Checkout ──────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v5

      # ── Validate .NET project ────────────────────────────────────────
      - name: Validate project structure
        working-directory: ${{ inputs.working-directory }}
        run: |
          if ! find . -maxdepth 3 -name "*.csproj" -o -name "*.fsproj" -o -name "*.sln" | grep -q .; then
            echo "::error::No .NET project files found (.csproj, .fsproj, or .sln)"
            exit 1
          fi
          echo "✓ .NET project structure validated"

      # ── .NET setup ───────────────────────────────────────────────────
      - name: Setup .NET ${{ matrix.dotnet-version }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      # ── NuGet cache ──────────────────────────────────────────────────
      - name: Cache NuGet packages
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ matrix.dotnet-version }}-${{ hashFiles('**/*.csproj', '**/*.fsproj', '**/Directory.Packages.props') }}
          restore-keys: |
            nuget-${{ runner.os }}-${{ matrix.dotnet-version }}-

      # ── Restore tools ────────────────────────────────────────────────
      - name: Restore .NET tools
        continue-on-error: true
        run: |
          if [ -f ".config/dotnet-tools.json" ]; then
            echo "Restoring .NET local tools..."
            dotnet tool restore
          fi

      # ── Restore ──────────────────────────────────────────────────────
      - name: Restore dependencies
        run: |
          set -e
          dotnet restore ${{ inputs.solution-file }}
          echo "✓ Dependencies restored successfully"
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.nuget-auth-token }}

      # ── Check for vulnerable packages ────────────────────────────────
      - name: Check for vulnerable packages
        continue-on-error: true
        run: dotnet list package --vulnerable --include-transitive

      # ── Format check ─────────────────────────────────────────────────
      - name: Check formatting
        if: inputs.enable-format-check
        run: dotnet format ${{ inputs.solution-file }} --verify-no-changes --verbosity diagnostic

      # ── Build ─────────────────────────────────────────────────────────
      - name: Build
        run: dotnet build ${{ inputs.solution-file }} --no-restore --configuration ${{ inputs.build-configuration }}

      # ── Test ──────────────────────────────────────────────────────────
      - name: Test
        if: inputs.enable-test
        run: |
          dotnet test ${{ inputs.solution-file }} \
            --no-build \
            --configuration ${{ inputs.build-configuration }} \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./test-results \
            ${{ inputs.dotnet-test-args }}

      # ── Test results ─────────────────────────────────────────────────
      - name: Upload test results
        if: always() && inputs.enable-test
        uses: actions/upload-artifact@v5
        with:
          name: test-results-dotnet-${{ matrix.dotnet-version }}
          path: ${{ inputs.working-directory }}/test-results/
          retention-days: 7
          if-no-files-found: ignore

      # ── Coverage ──────────────────────────────────────────────────────
      - name: Upload coverage to Codecov
        if: inputs.enable-coverage && inputs.enable-test
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.codecov-token }}
          directory: ./test-results
          flags: dotnet-${{ matrix.dotnet-version }}
          fail_ci_if_error: false
