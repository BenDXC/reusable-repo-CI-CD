# ============================================================================
# Reusable CD Workflow — Docker Build & Push
# ============================================================================
# Builds multi-platform Docker images and pushes to registries
# (Docker Hub, GHCR, ECR, GCR, ACR). Supports build caching, SBOM
# generation, and provenance attestation.
#
# Usage (caller workflow):
#   jobs:
#     docker:
#       uses: <owner>/<repo>/.github/workflows/reusable-cd-docker.yml@main
#       with:
#         image-name: "myorg/myapp"
#         push: true
#       secrets:
#         registry-username: ${{ secrets.DOCKER_USERNAME }}
#         registry-password: ${{ secrets.DOCKER_PASSWORD }}
# ============================================================================

name: "CD — Docker Build & Push"

on:
  workflow_call:
    inputs:
      registry:
        description: "Container registry: dockerhub | ghcr | ecr | gcr | acr | custom"
        type: string
        default: "ghcr"
      custom-registry-url:
        description: "Custom registry URL (only used when registry is 'custom')"
        type: string
        default: ""
      image-name:
        description: "Image name (e.g., myorg/myapp). Defaults to github.repository"
        type: string
        default: ""
      context:
        description: "Docker build context path"
        type: string
        default: "."
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "./Dockerfile"
      platforms:
        description: "Target platforms for multi-arch builds"
        type: string
        default: "linux/amd64,linux/arm64"
      push:
        description: "Push image to registry"
        type: boolean
        default: false
      build-args:
        description: "Docker build arguments (multiline KEY=VALUE)"
        type: string
        default: ""
      tags:
        description: "Custom tags (multiline). Leave empty for auto-tagging"
        type: string
        default: ""
      enable-cache:
        description: "Enable Docker layer caching"
        type: boolean
        default: true
      enable-sbom:
        description: "Generate SBOM attestation"
        type: boolean
        default: true
      enable-provenance:
        description: "Generate provenance attestation"
        type: boolean
        default: true
      target:
        description: "Docker build target (multi-stage builds)"
        type: string
        default: ""
    secrets:
      registry-username:
        description: "Registry username"
        required: false
      registry-password:
        description: "Registry password or token"
        required: false

    outputs:
      image-digest:
        description: "Image digest"
        value: ${{ jobs.docker.outputs.digest }}
      image-tags:
        description: "Image tags"
        value: ${{ jobs.docker.outputs.tags }}
      image-metadata:
        description: "Image metadata JSON"
        value: ${{ jobs.docker.outputs.metadata }}

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

jobs:
  docker:
    name: "Docker Build & Push"
    runs-on: ubuntu-latest
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}
      metadata: ${{ steps.meta.outputs.json }}

    steps:
      # ── Checkout ──────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v5

      # ── Determine registry URL ───────────────────────────────────────
      - name: Set registry URL
        id: registry
        run: |
          case "${{ inputs.registry }}" in
            dockerhub)  echo "url=docker.io" >> "$GITHUB_OUTPUT" ;;
            ghcr)       echo "url=ghcr.io" >> "$GITHUB_OUTPUT" ;;
            ecr)        echo "url=${{ inputs.custom-registry-url }}" >> "$GITHUB_OUTPUT" ;;
            gcr)        echo "url=gcr.io" >> "$GITHUB_OUTPUT" ;;
            acr)        echo "url=${{ inputs.custom-registry-url }}" >> "$GITHUB_OUTPUT" ;;
            custom)     echo "url=${{ inputs.custom-registry-url }}" >> "$GITHUB_OUTPUT" ;;
            *)          echo "url=ghcr.io" >> "$GITHUB_OUTPUT" ;;
          esac

      # ── Image name ───────────────────────────────────────────────────
      - name: Set image name
        id: image
        run: |
          if [ -n "${{ inputs.image-name }}" ]; then
            echo "name=${{ steps.registry.outputs.url }}/${{ inputs.image-name }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=${{ steps.registry.outputs.url }}/${{ github.repository }}" >> "$GITHUB_OUTPUT"
          fi

      # ── Docker Buildx ────────────────────────────────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v4

      # ── QEMU (for multi-platform builds) ─────────────────────────────
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v4

      # ── Registry login ───────────────────────────────────────────────
      - name: Log in to registry (GHCR)
        if: inputs.registry == 'ghcr' && inputs.push
        uses: docker/login-action@v4
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to registry (Docker Hub / custom)
        if: inputs.registry != 'ghcr' && inputs.push
        uses: docker/login-action@v4
        with:
          registry: ${{ steps.registry.outputs.url }}
          username: ${{ secrets.registry-username }}
          password: ${{ secrets.registry-password }}

      # ── Metadata (auto-tagging) ──────────────────────────────────────
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v6
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            ${{ inputs.tags }}
            type=schedule,pattern={{date 'YYYYMMDD'}}
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      # ── Build & Push ─────────────────────────────────────────────────
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v7
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: ${{ inputs.build-args }}
          target: ${{ inputs.target }}
          sbom: ${{ inputs.enable-sbom }}
          provenance: ${{ inputs.enable-provenance }}
          cache-from: ${{ inputs.enable-cache && 'type=gha' || '' }}
          cache-to: ${{ inputs.enable-cache && 'type=gha,mode=max' || '' }}

      # ── Scan image ───────────────────────────────────────────────────
      - name: Scan image with Trivy
        if: inputs.push
        uses: aquasecurity/trivy-action@0.30.0
        with:
          image-ref: ${{ steps.image.outputs.name }}@${{ steps.build.outputs.digest }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
        continue-on-error: true

      - name: Upload Trivy results
        if: inputs.push
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true

      # ── Inspect image ────────────────────────────────────────────────
      - name: Inspect image
        if: inputs.push
        run: |
          # Pull the image to inspect it
          PLATFORM=$(echo "${{ inputs.platforms }}" | cut -d',' -f1)
          docker pull --platform $PLATFORM ${{ steps.image.outputs.name }}@${{ steps.build.outputs.digest }}
          
          # Get image size
          SIZE=$(docker inspect ${{ steps.image.outputs.name }}@${{ steps.build.outputs.digest }} | jq -r '.[0].Size')
          SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
          
          echo "IMAGE_SIZE_MB=$SIZE_MB" >> "$GITHUB_ENV"

      # ── Summary ──────────────────────────────────────────────────────
      - name: Output image info
        run: |
          echo "## Docker Image Built" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "| --- | --- |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Digest** | \`${{ steps.build.outputs.digest }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Tags** | ${{ steps.meta.outputs.tags }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Platforms** | ${{ inputs.platforms }} |" >> "$GITHUB_STEP_SUMMARY"
          
          if [ -n "${{ env.IMAGE_SIZE_MB }}" ]; then
            echo "| **Size** | ${{ env.IMAGE_SIZE_MB }} MB |" >> "$GITHUB_STEP_SUMMARY"
            
            # Warning for large images
            if (( $(echo "${{ env.IMAGE_SIZE_MB }} > 500" | bc -l) )); then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "⚠️ **Warning:** Image is larger than 500MB. Consider optimizing with multi-stage builds." >> "$GITHUB_STEP_SUMMARY"
            fi
          fi
