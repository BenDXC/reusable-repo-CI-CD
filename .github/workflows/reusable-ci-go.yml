# ============================================================================
# Reusable CI Workflow — Go
# ============================================================================
# Runs linting (golangci-lint), tests with race detection, and builds.
#
# Usage (caller workflow):
#   jobs:
#     ci:
#       uses: <owner>/<repo>/.github/workflows/reusable-ci-go.yml@main
#       with:
#         go-versions: '["1.22", "1.23"]'
# ============================================================================

name: "CI — Go"

on:
  workflow_call:
    inputs:
      go-versions:
        description: "JSON array of Go versions to test"
        type: string
        default: '["1.23"]'
      working-directory:
        description: "Working directory for the project"
        type: string
        default: "."
      enable-lint:
        description: "Run golangci-lint"
        type: boolean
        default: true
      enable-test:
        description: "Run tests"
        type: boolean
        default: true
      enable-build:
        description: "Run build"
        type: boolean
        default: true
      enable-coverage:
        description: "Upload coverage reports"
        type: boolean
        default: false
      golangci-lint-version:
        description: "golangci-lint version"
        type: string
        default: "v1.62"
      test-args:
        description: "Additional test arguments"
        type: string
        default: "-race -count=1"
      build-args:
        description: "Additional build arguments"
        type: string
        default: "./..."
    secrets:
      codecov-token:
        description: "Codecov upload token"
        required: false

permissions:
  contents: read

jobs:
  go-ci:
    name: "Go ${{ matrix.go-version }}"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    strategy:
      fail-fast: false
      matrix:
        go-version: ${{ fromJSON(inputs.go-versions) }}

    steps:
      # ── Checkout ──────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v5

      # ── Validate Go project ──────────────────────────────────────────
      - name: Validate project structure
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ ! -f "go.mod" ]; then
            echo "::error::No go.mod found. This is not a Go module."
            exit 1
          fi
          echo "✓ Go project structure validated"

      # ── Go setup ─────────────────────────────────────────────────────
      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache-dependency-path: ${{ inputs.working-directory }}/go.sum

      # ── Validate Go version ──────────────────────────────────────────
      - name: Validate Go version
        working-directory: ${{ inputs.working-directory }}
        run: |
          GO_MOD_VERSION=$(grep -E '^go [0-9.]+' go.mod | awk '{print $2}')
          GO_ACTUAL_VERSION=$(go version | awk '{print $3}' | sed 's/go//')
          echo "go.mod requires: go $GO_MOD_VERSION"
          echo "Using: go $GO_ACTUAL_VERSION"
          
          if [ -n "$GO_MOD_VERSION" ]; then
            MAJOR_MOD=$(echo $GO_MOD_VERSION | cut -d. -f1)
            MINOR_MOD=$(echo $GO_MOD_VERSION | cut -d. -f2)
            MAJOR_ACTUAL=$(echo $GO_ACTUAL_VERSION | cut -d. -f1)
            MINOR_ACTUAL=$(echo $GO_ACTUAL_VERSION | cut -d. -f2)
            
            if [ "$MAJOR_ACTUAL" -lt "$MAJOR_MOD" ] || ([ "$MAJOR_ACTUAL" -eq "$MAJOR_MOD" ] && [ "$MINOR_ACTUAL" -lt "$MINOR_MOD" ]); then
              echo "::error::Go version mismatch. go.mod requires $GO_MOD_VERSION but using $GO_ACTUAL_VERSION"
              exit 1
            fi
          fi
          echo "✓ Go version validated"

      # ── Verify dependencies ──────────────────────────────────────────
      - name: Verify dependencies
        run: |
          go mod verify
          go mod tidy
          if ! git diff --exit-code go.mod go.sum; then
            echo "::warning::go.mod or go.sum is not tidy. Consider running 'go mod tidy' and committing."
          fi

      # ── Lint ──────────────────────────────────────────────────────────
      - name: Lint with golangci-lint
        if: inputs.enable-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: ${{ inputs.golangci-lint-version }}
          working-directory: ${{ inputs.working-directory }}

      # ── Test ──────────────────────────────────────────────────────────
      - name: Run tests
        if: inputs.enable-test
        run: |
          go test ${{ inputs.test-args }} -coverprofile=coverage.out -covermode=atomic ./...

      # ── Build ─────────────────────────────────────────────────────────
      - name: Build
        if: inputs.enable-build
        run: |
          set -e
          echo "Building Go binaries..."
          go build -v -o ./bin/ ${{ inputs.build-args }}
          echo "✓ Build completed successfully"

      # ── Upload build artifacts ────────────────────────────────────────
      - name: Upload build artifacts
        if: inputs.enable-build
        uses: actions/upload-artifact@v5
        with:
          name: go-build-${{ matrix.go-version }}
          path: ${{ inputs.working-directory }}/bin/
          retention-days: 7
          if-no-files-found: ignore

      # ── Security scan (govulncheck) ──────────────────────────────────
      - name: Run govulncheck
        if: inputs.enable-test
        continue-on-error: true
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      # ── Coverage ──────────────────────────────────────────────────────
      - name: Upload coverage to Codecov
        if: inputs.enable-coverage && inputs.enable-test
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.codecov-token }}
          files: ${{ inputs.working-directory }}/coverage.out
          flags: go-${{ matrix.go-version }}
          fail_ci_if_error: false
        continue-on-error: true
