# ============================================================================
# Reusable CI Workflow — Python
# ============================================================================
# Supports pip, pipenv, and poetry. Runs linting (ruff), type-checking (mypy),
# tests (pytest) with coverage, and optional security scanning.
#
# Usage (caller workflow):
#   jobs:
#     ci:
#       uses: <owner>/<repo>/.github/workflows/reusable-ci-python.yml@main
#       with:
#         python-versions: '["3.11", "3.12", "3.13"]'
# ============================================================================

name: "CI — Python"

on:
  workflow_call:
    inputs:
      python-versions:
        description: "JSON array of Python versions to test"
        type: string
        default: '["3.12"]'
      package-manager:
        description: "Package manager: pip | pipenv | poetry"
        type: string
        default: "pip"
      working-directory:
        description: "Working directory for the project"
        type: string
        default: "."
      enable-lint:
        description: "Run linting with ruff"
        type: boolean
        default: true
      enable-type-check:
        description: "Run type checking with mypy"
        type: boolean
        default: false
      enable-test:
        description: "Run tests with pytest"
        type: boolean
        default: true
      enable-coverage:
        description: "Upload coverage reports"
        type: boolean
        default: false
      requirements-file:
        description: "Path to requirements file (for pip)"
        type: string
        default: "requirements.txt"
      extra-system-deps:
        description: "Extra apt packages to install (space-separated)"
        type: string
        default: ""
      pytest-args:
        description: "Additional arguments for pytest"
        type: string
        default: ""
      ruff-args:
        description: "Additional arguments for ruff"
        type: string
        default: ""
    secrets:
      codecov-token:
        description: "Codecov upload token"
        required: false

permissions:
  contents: read

jobs:
  python-ci:
    name: "Python ${{ matrix.python-version }}"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(inputs.python-versions) }}

    steps:
      # ── Checkout ──────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v5

      # ── Validate Python project ──────────────────────────────────────
      - name: Validate project structure
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ ! -f "setup.py" ] && [ ! -f "setup.cfg" ] && [ ! -f "pyproject.toml" ] && [ ! -f "${{ inputs.requirements-file }}" ]; then
            echo "::error::No Python project configuration found (setup.py, pyproject.toml, or ${{ inputs.requirements-file }})"
            exit 1
          fi
          echo "✓ Python project structure validated"

      # ── System dependencies ───────────────────────────────────────────
      - name: Install system dependencies
        if: inputs.extra-system-deps != ''
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ${{ inputs.extra-system-deps }}

      # ── Python setup ──────────────────────────────────────────────────
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      # ── Cache ─────────────────────────────────────────────────────────
      - name: Cache pip packages
        if: inputs.package-manager == 'pip'
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt', '**/setup.py', '**/setup.cfg', '**/pyproject.toml') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Cache Poetry
        if: inputs.package-manager == 'poetry'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pypoetry
            .venv
          key: poetry-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Cache Pipenv
        if: inputs.package-manager == 'pipenv'
        uses: actions/cache@v5
        with:
          path: ~/.local/share/virtualenvs
          key: pipenv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/Pipfile.lock') }}
          restore-keys: |
            pipenv-${{ runner.os }}-${{ matrix.python-version }}-

      # ── Install dependencies ──────────────────────────────────────────
      - name: Install dependencies (pip)
        if: inputs.package-manager == 'pip'
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          
          # Install main dependencies
          if [ -f "${{ inputs.requirements-file }}" ]; then
            echo "Installing from ${{ inputs.requirements-file }}..."
            pip install -r "${{ inputs.requirements-file }}"
          fi
          
          # Install dev dependencies
          if [ -f "requirements-dev.txt" ]; then
            echo "Installing dev dependencies..."
            pip install -r requirements-dev.txt
          fi
          
          # Install package in editable mode if pyproject.toml exists
          if [ -f "pyproject.toml" ]; then
            echo "Installing package in editable mode..."
            if pip install -e ".[dev]"; then
              echo "✓ Installed with dev extras"
            elif pip install -e .; then
              echo "✓ Installed without dev extras"
            else
              echo "::warning::Could not install package in editable mode"
            fi
          fi
          
          echo "✓ Dependencies installed successfully"

      - name: Install dependencies (poetry)
        if: inputs.package-manager == 'poetry'
        run: |
          set -e
          pip install poetry
          poetry config virtualenvs.in-project true
          poetry config virtualenvs.create true
          echo "Installing dependencies with Poetry..."
          poetry install --no-interaction --no-ansi --no-root
          poetry install --no-interaction --no-ansi
          echo "✓ Poetry dependencies installed successfully"

      - name: Install dependencies (pipenv)
        if: inputs.package-manager == 'pipenv'
        run: |
          set -e
          pip install pipenv
          echo "Installing dependencies with Pipenv..."
          pipenv install --dev --deploy
          echo "✓ Pipenv dependencies installed successfully"

      # ── Lint ──────────────────────────────────────────────────────────
      - name: Lint with ruff
        if: inputs.enable-lint
        run: |
          command -v ruff >/dev/null 2>&1 || pip install ruff
          ruff check ${{ inputs.ruff-args }} .
          ruff format --check .

      # ── Type check ───────────────────────────────────────────────────
      - name: Type check with mypy
        if: inputs.enable-type-check
        run: |
          command -v mypy >/dev/null 2>&1 || pip install mypy
          mypy .

      # ── Test ──────────────────────────────────────────────────────────
      - name: Run tests with pytest
        if: inputs.enable-test
        run: |
          command -v pytest >/dev/null 2>&1 || pip install pytest pytest-cov
          pytest ${{ inputs.pytest-args }} --cov --cov-report=xml --cov-report=term-missing -v

      # ── Coverage ──────────────────────────────────────────────────────
      - name: Upload coverage to Codecov
        if: inputs.enable-coverage && inputs.enable-test
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.codecov-token }}
          files: ${{ inputs.working-directory }}/coverage.xml
          flags: python-${{ matrix.python-version }}
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true
        
      - name: Upload coverage artifacts
        if: inputs.enable-coverage && inputs.enable-test && always()
        uses: actions/upload-artifact@v5
        with:
          name: coverage-python-${{ matrix.python-version }}
          path: |
            ${{ inputs.working-directory }}/coverage.xml
            ${{ inputs.working-directory }}/htmlcov/
          retention-days: 7
          if-no-files-found: ignore
