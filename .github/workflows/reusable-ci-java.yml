# ============================================================================
# Reusable CI Workflow — Java (Maven / Gradle)
# ============================================================================
# Supports Maven and Gradle build tools with multi-JDK matrix testing.
#
# Usage (caller workflow):
#   jobs:
#     ci:
#       uses: <owner>/<repo>/.github/workflows/reusable-ci-java.yml@main
#       with:
#         java-versions: '["17", "21"]'
#         build-tool: "maven"
# ============================================================================

name: "CI — Java"

on:
  workflow_call:
    inputs:
      java-versions:
        description: "JSON array of Java versions to test"
        type: string
        default: '["21"]'
      distribution:
        description: "Java distribution: temurin | corretto | microsoft | oracle | zulu"
        type: string
        default: "temurin"
      build-tool:
        description: "Build tool: maven | gradle"
        type: string
        default: "maven"
      working-directory:
        description: "Working directory for the project"
        type: string
        default: "."
      enable-test:
        description: "Run tests"
        type: boolean
        default: true
      enable-coverage:
        description: "Upload coverage reports"
        type: boolean
        default: false
      maven-args:
        description: "Additional Maven arguments"
        type: string
        default: ""
      gradle-args:
        description: "Additional Gradle arguments"
        type: string
        default: ""
    secrets:
      codecov-token:
        description: "Codecov upload token"
        required: false

permissions:
  contents: read

jobs:
  java-ci:
    name: "Java ${{ matrix.java-version }} (${{ inputs.build-tool }})"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    strategy:
      fail-fast: false
      matrix:
        java-version: ${{ fromJSON(inputs.java-versions) }}

    steps:
      # ── Checkout ──────────────────────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v5

      # ── Validate Java project ────────────────────────────────────────
      - name: Validate project structure
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ "${{ inputs.build-tool }}" = "maven" ]; then
            if [ ! -f "pom.xml" ]; then
              echo "::error::No pom.xml found for Maven project"
              exit 1
            fi
          elif [ "${{ inputs.build-tool }}" = "gradle" ]; then
            if [ ! -f "build.gradle" ] && [ ! -f "build.gradle.kts" ]; then
              echo "::error::No build.gradle or build.gradle.kts found for Gradle project"
              exit 1
            fi
          fi
          echo "✓ Java project structure validated"

      # ── Java setup ───────────────────────────────────────────────────
      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java-version }}
          distribution: ${{ inputs.distribution }}
          cache: ${{ inputs.build-tool }}

      # ── Gradle wrapper validation ────────────────────────────────────
      - name: Validate Gradle wrapper
        if: inputs.build-tool == 'gradle'
        uses: gradle/actions/wrapper-validation@v5

      # ── Compile (Maven) ──────────────────────────────────────────────
      - name: Compile with Maven
        if: inputs.build-tool == 'maven'
        run: |
          chmod +x mvnw 2>/dev/null || true
          if [ -f "mvnw" ]; then
            echo "Compiling with Maven wrapper..."
            ./mvnw -B compile -DskipTests ${{ inputs.maven-args }}
          else
            echo "Compiling with Maven..."
            mvn -B compile -DskipTests ${{ inputs.maven-args }}
          fi
          echo "✓ Compilation successful"

      # ── Build & Test (Maven) ─────────────────────────────────────────
      - name: Test with Maven
        if: inputs.build-tool == 'maven' && inputs.enable-test
        run: |
          if [ -f "mvnw" ]; then
            ./mvnw -B verify ${{ inputs.maven-args }}
          else
            mvn -B verify ${{ inputs.maven-args }}
          fi
          echo "✓ Tests passed successfully"

      # ── Compile (Gradle) ─────────────────────────────────────────────
      - name: Compile with Gradle
        if: inputs.build-tool == 'gradle'
        run: |
          chmod +x gradlew 2>/dev/null || true
          if [ -f "gradlew" ]; then
            echo "Compiling with Gradle wrapper..."
            ./gradlew compileJava compileTestJava ${{ inputs.gradle-args }}
          else
            echo "Compiling with Gradle..."
            gradle compileJava compileTestJava ${{ inputs.gradle-args }}
          fi
          echo "✓ Compilation successful"

      # ── Build & Test (Gradle) ────────────────────────────────────────
      - name: Test with Gradle
        if: inputs.build-tool == 'gradle' && inputs.enable-test
        run: |
          if [ -f "gradlew" ]; then
            ./gradlew build ${{ inputs.gradle-args }}
          else
            gradle build ${{ inputs.gradle-args }}
          fi
          echo "✓ Tests passed successfully"

      # ── Test reports ─────────────────────────────────────────────────
      - name: Upload test results
        if: always() && inputs.enable-test
        uses: actions/upload-artifact@v5
        with:
          name: test-results-java-${{ matrix.java-version }}
          path: |
            ${{ inputs.working-directory }}/**/target/surefire-reports/
            ${{ inputs.working-directory }}/**/target/failsafe-reports/
            ${{ inputs.working-directory }}/**/build/reports/tests/
          retention-days: 7
          if-no-files-found: ignore

      # ── Coverage ──────────────────────────────────────────────────────
      - name: Upload coverage to Codecov
        if: inputs.enable-coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.codecov-token }}
          flags: java-${{ matrix.java-version }}
          fail_ci_if_error: false
